(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))r(l);new MutationObserver(l=>{for(const n of l)if(n.type==="childList")for(const c of n.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function o(l){const n={};return l.integrity&&(n.integrity=l.integrity),l.referrerPolicy&&(n.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?n.credentials="include":l.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function r(l){if(l.ep)return;l.ep=!0;const n=o(l);fetch(l.href,n)}})();let s;const K=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}};typeof TextDecoder<"u"&&K.decode();let C=null;function ae(){return(C===null||C.byteLength===0)&&(C=new Uint8Array(s.memory.buffer)),C}function q(e,t){return e=e>>>0,K.decode(ae().subarray(e,e+t))}let W=null;function _e(){return(W===null||W.byteLength===0)&&(W=new Uint32Array(s.memory.buffer)),W}function ge(e,t){return e=e>>>0,_e().subarray(e/4,e/4+t)}let P=null;function Q(){return(P===null||P.byteLength===0)&&(P=new Float32Array(s.memory.buffer)),P}function V(e,t){return e=e>>>0,Q().subarray(e/4,e/4+t)}let Z=0;function ue(e,t){const o=t(e.length*4,4)>>>0;return Q().set(e,o/4),Z=e.length,o}typeof FinalizationRegistry>"u"||new FinalizationRegistry(e=>s.__wbg_obstacle_free(e>>>0,1));const G=typeof FinalizationRegistry>"u"?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_world_free(e>>>0,1));class X{__destroy_into_raw(){const t=this.__wbg_ptr;return this.__wbg_ptr=0,G.unregister(this),t}free(){const t=this.__destroy_into_raw();s.__wbg_world_free(t,0)}constructor(t){const o=s.world_new(t);return this.__wbg_ptr=o>>>0,G.register(this,this.__wbg_ptr,this),this}update(t){s.world_update(this.__wbg_ptr,t)}get_best_dino_x(){return s.world_get_best_dino_x(this.__wbg_ptr)}get_best_dino_y(){return s.world_get_best_dino_y(this.__wbg_ptr)}get_best_dino_velocity_y(){return s.world_get_best_dino_velocity_y(this.__wbg_ptr)}get_best_index(){return s.world_get_best_index(this.__wbg_ptr)>>>0}get_best_score(){return s.world_get_best_score(this.__wbg_ptr)>>>0}get_generation(){return s.world_get_generation(this.__wbg_ptr)>>>0}get_obstacle_count(){return s.world_get_obstacle_count(this.__wbg_ptr)>>>0}get_obstacle_x(t){return s.world_get_obstacle_x(this.__wbg_ptr,t)}get_fitness_history(){const t=s.world_get_fitness_history(this.__wbg_ptr);var o=ge(t[0],t[1]).slice();return s.__wbindgen_free(t[0],t[1]*4,4),o}get_score_of(t){return s.world_get_score_of(this.__wbg_ptr,t)>>>0}get_best_input_weights(){const t=s.world_get_best_input_weights(this.__wbg_ptr);var o=V(t[0],t[1]).slice();return s.__wbindgen_free(t[0],t[1]*4,4),o}get_best_output_weights(){const t=s.world_get_best_output_weights(this.__wbg_ptr);var o=V(t[0],t[1]).slice();return s.__wbindgen_free(t[0],t[1]*4,4),o}get_best_bias(){return s.world_get_best_bias(this.__wbg_ptr)}set_best_weights(t){const o=ue(t,s.__wbindgen_malloc),r=Z;s.world_set_best_weights(this.__wbg_ptr,o,r)}set_best_bias(t){s.world_set_best_bias(this.__wbg_ptr,t)}count_alive(){return s.world_count_alive(this.__wbg_ptr)>>>0}get_average_score(){return s.world_get_average_score(this.__wbg_ptr)}is_alive(t){return s.world_is_alive(this.__wbg_ptr,t)!==0}get_population_size(){return s.world_get_population_size(this.__wbg_ptr)>>>0}get_dino_x(t){return s.world_get_dino_x(this.__wbg_ptr,t)}get_dino_y(t){return s.world_get_dino_y(this.__wbg_ptr,t)}get_speed_multiplier(){return s.world_get_speed_multiplier(this.__wbg_ptr)}}async function de(e,t){if(typeof Response=="function"&&e instanceof Response){if(typeof WebAssembly.instantiateStreaming=="function")try{return await WebAssembly.instantiateStreaming(e,t)}catch(r){if(e.headers.get("Content-Type")!="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",r);else throw r}const o=await e.arrayBuffer();return await WebAssembly.instantiate(o,t)}else{const o=await WebAssembly.instantiate(e,t);return o instanceof WebAssembly.Instance?{instance:o,module:e}:o}}function fe(){const e={};return e.wbg={},e.wbg.__wbg_log_c222819a41e063d3=function(t){console.log(t)},e.wbg.__wbg_warn_4ca3906c248c47c4=function(t){console.warn(t)},e.wbg.__wbindgen_init_externref_table=function(){const t=s.__wbindgen_export_0,o=t.grow(4);t.set(0,void 0),t.set(o+0,void 0),t.set(o+1,null),t.set(o+2,!0),t.set(o+3,!1)},e.wbg.__wbindgen_string_new=function(t,o){return q(t,o)},e.wbg.__wbindgen_throw=function(t,o){throw new Error(q(t,o))},e}function be(e,t){return s=e.exports,ee.__wbindgen_wasm_module=t,P=null,W=null,C=null,s.__wbindgen_start(),s}async function ee(e){if(s!==void 0)return s;typeof e<"u"&&(Object.getPrototypeOf(e)===Object.prototype?{module_or_path:e}=e:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),typeof e>"u"&&(e=new URL("/robo-dino/assets/rust_dino_bg-ByiRisMY.wasm",import.meta.url));const t=fe();(typeof e=="string"||typeof Request=="function"&&e instanceof Request||typeof URL=="function"&&e instanceof URL)&&(e=fetch(e));const{instance:o,module:r}=await de(await e,t);return be(o,r)}let a,te=1,T=200,O=!0,ne=!0;const x=document.getElementById("main"),f=x.getContext("2d"),k=document.getElementById("fitness"),M=k.getContext("2d");let $=[];const R=document.getElementById("weightsCanvas"),z=R.getContext("2d"),L=document.getElementById("neuralNet"),w=L.getContext("2d"),oe="rgb(173, 216, 230)",ie="rgb(0, 128, 128)",re="rgb(238, 130, 238)";function he(e){return 1/(1+Math.exp(-e))}function we(e,t,o){let r=0,l=0,n=0,c=0,d=0,p=0;try{const b=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(b)[r,l,n]=b.slice(1).map(Number);else return e;t==="white"&&([c,d,p]=[255,255,255])}catch(b){return console.error("Color parsing/interpolation failed",b),e}const g=Math.round(r+(c-r)*o),h=Math.round(l+(d-l)*o),y=Math.round(n+(p-n)*o);return`rgb(${g}, ${h}, ${y})`}function pe(e){const t=(e+1)/2,o=Math.floor(t*255),r=Math.floor((1-t)*255);return`rgb(${o}, 0, ${r})`}function ye(){const e=a.get_best_input_weights(),t=3,o=Math.ceil(e.length/t),r=R.width/o,l=R.height/t;z.clearRect(0,0,R.width,R.height);for(let n=0;n<e.length;n++){const c=Math.floor(n/o),d=n%o;z.fillStyle=pe(e[n]),z.fillRect(d*r,c*l,r,l)}}function H(e,t,o,r,l,n,c,d,p){const g=Math.max(0,Math.min(1,d)),h=.005,b=r*.2*g,m=r+b*Math.sin(h*p),v=g*.3,S=we(l,"white",v);e.beginPath(),e.arc(t,o,m,0,2*Math.PI),e.fillStyle=S,e.fill(),e.strokeStyle="black",e.lineWidth=1,e.stroke(),e.fillStyle="black",e.font="10px monospace",e.textAlign="center",e.fillText(`${n}`,t,o-m-5),e.fillText(c.toFixed(2),t,o+4),e.textAlign="start"}function J(e,t,o,r,l){const n=Math.max(-1,Math.min(1,l)),c=Math.floor(Math.abs(n)*255),d=n>=0?`rgb(${c},0,0)`:`rgb(${c/2},${c/2},${c})`;w.strokeStyle=d,w.lineWidth=1+Math.abs(n)*2,w.beginPath(),w.moveTo(e,t),w.lineTo(o,r),w.stroke()}function me(e,t,o){const r="10px monospace";let n=o;e.fillStyle="black",e.font=r,e.fillText("Legend:",t,n),n+=12*1.5,e.fillText("Connections:",t,n),n+=12,e.strokeStyle="rgb(255,0,0)",e.lineWidth=1+1*2,e.beginPath(),e.moveTo(t,n),e.lineTo(t+20,n),e.stroke(),e.fillStyle="black",e.fillText("+ Weight (Intensity)",t+25,n+3),n+=12,e.strokeStyle="rgb(127,127,255)",e.lineWidth=1+1*2,e.beginPath(),e.moveTo(t,n),e.lineTo(t+20,n),e.stroke(),e.fillStyle="black",e.fillText("- Weight (Intensity)",t+25,n+3),n+=12*1.5,e.fillText("Neurons:",t,n),n+=12,e.fillStyle=oe,e.beginPath(),e.arc(t+10,n,5,0,2*Math.PI),e.fill(),e.fillStyle="black",e.fillText("Input",t+25,n+3),n+=12,e.fillStyle=ie,e.beginPath(),e.arc(t+10,n,5,0,2*Math.PI),e.fill(),e.fillStyle="black",e.fillText("Hidden",t+25,n+3),n+=12,e.fillStyle=re,e.beginPath(),e.arc(t+10,n,5,0,2*Math.PI),e.fill(),e.fillStyle="black",e.fillText("Output (Jump)",t+25,n+3),n+=12*1.5,e.fillText("Neuron activation:",t,n),n+=12,e.fillText("Pulsing/luminosity",t+5,n),n+=12,e.fillText("= Neuron output",t+5,n),e.strokeStyle="black",e.lineWidth=1}function ve(e){w.clearRect(0,0,L.width,L.height);const t=["Dist.","Vert. Speed","Horiz. Speed"],o=a.get_best_input_weights(),r=a.get_best_output_weights(),l=a.get_best_bias(),n=r.length,c=t.length,d=18,p=[],g=[],h=a.get_best_dino_x(),y=a.get_best_dino_velocity_y();let b=1/0;for(let i=0;i<a.get_obstacle_count();i++){const u=a.get_obstacle_x(i)-h;u>0&&u<b&&(b=u)}const m=b===1/0?x.width:b,v=y,S=a.get_speed_multiplier(),B=[m/100,v/10,S/5];function U(i,_,u=!1){const A=u?1:i%2,I=u?i+.5:Math.floor(i/2);return[_+A*40,50+I*60]}for(let i=0;i<c;i++){const[_,u]=U(i,50,!0);p.push({x:_,y:u})}for(let i=0;i<n;i++){const[_,u]=U(i,150,!0);g.push({x:_,y:u})}const j=300,D=140;for(let i=0;i<n;i++)for(let _=0;_<c;_++){const u=p[_],A=g[i],I=o[i*c+_];J(u.x,u.y,A.x,A.y,I)}for(let i=0;i<n;i++){const _=g[i];J(_.x,_.y,j,D,r[i])}const F=[];for(let i=0;i<n;i++){const _=B.reduce((A,I,Y)=>A+I*o[i*c+Y],0),u=1/(1+Math.exp(-_));F.push(u)}const le=F.reduce((i,_,u)=>i+_*r[u],0)+l,N=he(le);for(let i=0;i<c;i++){const{x:_,y:u}=p[i];H(w,_,u,d,oe,t[i],B[i],B[i],e)}for(let i=0;i<n;i++){const{x:_,y:u}=g[i];H(w,_,u,d,ie,"",F[i],F[i],e)}const ce=N>.6?N:0;H(w,j,D,d,re,"Jump",N,ce,e),me(w,L.width-160,20)}function Se(){const e=x.width,t=x.height;f.clearRect(0,0,e,t),f.fillStyle="brown",f.fillRect(0,t-20,e,20);const o=a.get_population_size?.()??1,r=20,l=a.get_best_index?.(),n=typeof l=="number"&&l>=0;for(let g=0;g<o;g++){const h=a.is_alive(g);let y=!1;if(O||(h&&console.log("hasValidBestIndex",n,"i",g,"bestIndex",l,"alive",h,"showAll",O),(!n||g!==l)&&(y=!0)),!y&&ne&&!h&&(y=!0),y)continue;const b=a.get_dino_x(g),m=a.get_dino_y(g),v=t-20-m-r,S="rgba(128, 128, 128, 0.05)";f.fillStyle=h?"green":S,f.fillRect(b,v,r,r),f.strokeStyle=h?"white":S,f.lineWidth=1,f.strokeRect(b,v,r,r)}for(let g=0;g<a.get_obstacle_count();g++){const h=a.get_obstacle_x(g);f.fillStyle="red",f.fillRect(h,t-20-30,5,30)}const c=a.get_best_score(),d=a.count_alive(),p=a.get_generation();f.fillStyle="black",f.font="14px monospace",f.fillText(`Score: ${c}`,10,20),f.fillText(`Alive: ${d}`,100,20),f.fillText(`Generation: ${p}`,350,20)}function Ae(e){M.clearRect(0,0,k.width,k.height);const t=Math.max(...e,10),o=k.width,r=k.height;M.beginPath(),M.moveTo(0,r),e.forEach((l,n)=>{const c=n/e.length*o,d=r-l/t*r;M.lineTo(c,d)}),M.strokeStyle="blue",M.stroke()}function se(e,t){if(E||a.update(1/60*te),Se(),ye(),Ae($),ve(e),!E){const o=a.get_best_score();$.push(o)}requestAnimationFrame(o=>se(o))}ee().then(e=>{a=new X(T),requestAnimationFrame(t=>se(t,e.memory.buffer))});let E=!1;document.getElementById("togglePause").addEventListener("click",()=>{E=!E;const e=document.getElementById("togglePause");e.textContent=E?"▶️ Resume":"⏸️ Pause"});document.getElementById("speed").addEventListener("input",e=>{te=parseFloat(e.target.value)});document.getElementById("showAll").addEventListener("change",e=>{O=e.target.checked});document.getElementById("showOnlyAlive").addEventListener("change",e=>{ne=e.target.checked});document.getElementById("applySettings").addEventListener("click",()=>{const e=document.getElementById("agents"),t=parseInt(e.value);!isNaN(t)&&t>0&&t!==T?(T=t,$=[],a=new X(T),console.log(`Restarted with ${T} agents.`)):(isNaN(t)||t<=0)&&(console.warn("Invalid agent count specified."),e.value=T.toString())});
